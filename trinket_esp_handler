local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local ConnectionManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/Rakise/Puppy-Hub/refs/heads/main/ConnectionManager"))()

local TrinketESP = {}
TrinketESP.__index = TrinketESP

-- UPDATED: Color configurations
local TrinketEspColor = Color3.new(1, 1, 1)
local ArtifactEspColor = Color3.new(1, 1, 1) -- Can be changed dynamically

-- UPDATED: Meshes and Detection Logic provided by user
local Meshes = {
    ["rbxassetid://5196776695"] = "Ring",
    ["rbxassetid://5204003946"] = "Goblet",
    ["rbxassetid://5196782997"] = "Old Ring",
    ["rbxassetid://5204453430"] = "Scroll",
    ["rbxassetid://5196551436"] = "Amulet",
    ["rbxassetid://5196577540"] = "Old Amulet",
    ["rbxassetid://4103271893"] = "Candy",
    ["rbxassetid://4027112893"] = "Bound Book"
}

-- Helpers
local function GetLabelName(obj)
    local p = obj.Parent
    if not p then return nil end
    
    local color = p.Color
    local mesh = p:FindFirstChildWhichIsA("SpecialMesh")
    local attachment = p:FindFirstChild("Attachment")
    local particle = p:FindFirstChildWhichIsA("ParticleEmitter", true)

    if p:IsA("Part") then
        if p:FindFirstChild("OrbParticle") and color == Color3.fromRGB(89, 34, 89) then return "???", false end
        if color == Color3.fromRGB(128, 187, 219) then return "Fairfrozen", true end
        if color == Color3.fromRGB(164, 187, 190) then return "Diamond", false end
        if color == Color3.fromRGB(0, 184, 49) then return "Emerald", false end
        if color == Color3.fromRGB(16, 42, 220) then return "Sapphire", false end
        if color == Color3.fromRGB(255, 0, 0) then return "Ruby", false end
        if p:FindFirstChild("OrbParticle") and p.OrbParticle.Texture == "rbxassetid://20443483" then return "Ice Essence", true end
        if particle and particle.Color.Keypoints[1].Value == Color3.new(1, 0.8, 0) then return "Phoenix Down", true end
        if attachment and attachment:FindFirstChild("ParticleEmitter") then
            local pe = attachment.ParticleEmitter
            if pe.Texture == "rbxassetid://1536547385" then
                if game.PlaceId == 3541987450 then return "Phoenix Flower", true end
                if pe.Color.Keypoints[1].Value == Color3.new(0, 1, 0.207843) then return "Azael Horn", true end
                return "Mysterious Artifact", true
            end
        end
        if p.Material == Enum.Material.Glass and color == Color3.fromRGB(248, 248, 248) and mesh then return "Opal", false end
        return "Unregistered Artifact", true
    elseif p:IsA("UnionOperation") then
        if color == Color3.fromRGB(248, 248, 248) and not p.UsePartColor then return "Lannis Amulet", true end
        if color == Color3.fromRGB(29, 46, 58) then return "Night Stone", true end
        if color == Color3.fromRGB(163, 162, 165) then return "Amulet Of The White King", true end
        if color == Color3.fromRGB(111, 113, 125) then return "Idol Of Forgotten", false end
    elseif p:IsA("MeshPart") and Meshes[p.MeshId] then
        return Meshes[p.MeshId], false
    end

    if mesh and Meshes[mesh.MeshId] then
        return Meshes[mesh.MeshId], false
    end

    return nil
end

local function isTrinket(obj)
    -- The GetLabelName function expects 'obj' to be the ClickDetector or similar, or we check the parent directly?
    -- The provided logic says "local p = obj.Parent". This usually means 'obj' is a ClickDetector.
    -- Rogue Lineage trinkets usually have a ClickDetector inside the part.
    if obj:IsA("ClickDetector") then
        local name, isArtifact = GetLabelName(obj)
        return name ~= nil, name, isArtifact
    end
    return false, nil, false
end

function TrinketESP.new()
    return setmetatable({
        espBillboards = {},
        _connectionManager = ConnectionManager.new(),
        enabled = false,
        _processedObjects = {},
        _lastGCTime = 0,
        labels = {},     -- Regular trinket labels
        artilabels = {}, -- Artifact labels
    }, TrinketESP)
end

function TrinketESP:createBillboard(clickDetector, name, isArtifact)
    if self.espBillboards[clickDetector] then return end
    
    local part = clickDetector.Parent
    if not part then return end

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "TrinketESP"
    billboard.Adornee = part
    billboard.LightInfluence = 1
    billboard.AlwaysOnTop = true
    billboard.Size = UDim2.new(0, 100, 0, 100)
    billboard.Parent = part

    local label = Instance.new("TextLabel")
    label.Text = name
    label.TextColor3 = isArtifact and ArtifactEspColor or TrinketEspColor
    label.TextStrokeTransparency = 0.5
    label.TextStrokeColor3 = Color3.new(0,0,0)
    label.Font = Enum.Font.SourceSans
    label.TextSize = 14
    label.BackgroundTransparency = 1
    label.BorderSizePixel = 0
    label.Size = UDim2.new(1, 0, 1, 0)
    label.Position = UDim2.new(0.5, 0, 0.5, 0)
    label.AnchorPoint = Vector2.new(0.5, 0.5)
    label.Parent = billboard

    self.espBillboards[clickDetector] = billboard
    
    if isArtifact then
        table.insert(self.artilabels, label)
    else
        table.insert(self.labels, label)
    end
end

function TrinketESP:removeBillboard(clickDetector)
    local billboard = self.espBillboards[clickDetector]
    if billboard then
        -- Remove from labels tables
        local label = billboard:FindFirstChild("TextLabel")
        if label then
            for i, v in ipairs(self.labels) do if v == label then table.remove(self.labels, i) break end end
            for i, v in ipairs(self.artilabels) do if v == label then table.remove(self.artilabels, i) break end end
        end
        billboard:Destroy()
        self.espBillboards[clickDetector] = nil
    end
    self._processedObjects[clickDetector] = nil
end

function TrinketESP:scanExistingTrinkets()
    for _, v in ipairs(Workspace:GetDescendants()) do
        if v:IsA("ClickDetector") and not self._processedObjects[v] then
            local isTrinket, name, isArtifact = isTrinket(v)
            if isTrinket then
                self._processedObjects[v] = true
                self:createBillboard(v, name, isArtifact)
            end
        end
    end
end

function TrinketESP:clearAllBillboards()
    for cd, _ in pairs(self.espBillboards) do
        self:removeBillboard(cd)
    end
    self.labels = {}
    self.artilabels = {}
    self._processedObjects = {}
    self:scanExistingTrinkets()
end

function TrinketESP:enable()
    if self.enabled then return end
    self.enabled = true
    
    self:scanExistingTrinkets()
    
    self._connectionManager:add(Workspace.DescendantAdded:Connect(function(v)
        if v:IsA("ClickDetector") then
            local isT, name, isA = isTrinket(v)
            if isT then
                self._processedObjects[v] = true
                self:createBillboard(v, name, isA)
            end
        end
    end))
    
    self._connectionManager:add(Workspace.DescendantRemoving:Connect(function(v)
        if self.espBillboards[v] then
            self:removeBillboard(v)
        end
    end))
    
    -- Color update loop (Dynamic colors as requested)
    self._connectionManager:add(RunService.Heartbeat:Connect(function()
        if not self.enabled then return end
        -- Note: Color updating logic can be here if TrinketEspColor/ArtifactEspColor change dynamically
        -- For now they are static, but the structure allows for it.
        for _, v in pairs(self.labels) do v.TextColor3 = TrinketEspColor end
        for _, v in pairs(self.artilabels) do v.TextColor3 = ArtifactEspColor end
    end))
end

function TrinketESP:disable()
    self.enabled = false
    self._connectionManager:disconnectAll()
    self:clearAllBillboards() -- Clean visuals on disable
end

return TrinketESP